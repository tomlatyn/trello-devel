<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Reset All Approvals</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="reset-confirmation">
    <div class="confirmation-content">
        <p>Are you sure you want to reset all approvals to pending status?</p>
        <p class="warning">This action cannot be undone.</p>
        
        <div class="action-buttons">
            <button id="cancel-button" class="btn-secondary">Cancel</button>
            <button id="reset-button" class="btn-danger">Reset All</button>
        </div>
    </div>
    
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="js/mock-data.js"></script>
    <script src="js/mock-utils.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();
        
        // Apply theme on page load
        function applyTheme() {
            try {
                var context = t.getContext();
                var theme = context ? (context.theme || context.initialTheme || 'light') : 'light';
                
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            } catch (error) {
                console.log('Theme context not available, using light theme:', error.message);
                document.body.classList.remove('dark-mode');
            }
        }
        
        // Subscribe to theme changes
        try {
            t.subscribeToThemeChanges(function(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            });
        } catch (error) {
            console.log('Theme subscription not available:', error.message);
        }
        
        function resetAllApprovals() {
            console.log('üîÑ Resetting all approvals...');
            
            return TrelloMockUtils.api.getApprovalData()
            .then(function(approvalData) {
                if (!approvalData || !approvalData.members) {
                    console.log('‚ùå No approval data or members found');
                    return;
                }
                
                console.log('üîÑ Resetting statuses for', Object.keys(approvalData.members).length, 'members');
                
                // Reset all members to pending status
                Object.keys(approvalData.members).forEach(function(memberId) {
                    console.log('Resetting member:', memberId, 'from', approvalData.members[memberId].status, 'to pending');
                    approvalData.members[memberId].status = 'pending';
                    approvalData.members[memberId].actionDate = new Date().toISOString();
                });
                
                console.log('üíæ Saving updated approval data...');
                return TrelloMockUtils.api.saveApprovalData(approvalData);
            })
            .then(function() {
                console.log('‚úÖ Data saved successfully!');
                console.log('üîÑ Closing popup...');
                
                // Close popup and try to signal parent
                if (TrelloMockUtils.isMockMode()) {
                    alert('‚úÖ Approvals reset successfully! (Mock mode)');
                    return TrelloMockUtils.api.closePopup();
                } else {
                    // Close popup - the card will auto-refresh due to data changes via t.set()
                    return t.closePopup();
                }
            })
            .catch(function(error) {
                console.error('‚ùå Error resetting approvals:', error);
                alert('Failed to reset approvals. Please try again.');
            });
        }
        
        // Event listeners
        document.getElementById('cancel-button').addEventListener('click', function() {
            TrelloMockUtils.api.closePopup();
        });
        
        document.getElementById('reset-button').addEventListener('click', function() {
            resetAllApprovals();
        });
        
        // Initialize theme when popup opens
        function initialize() {
            if (window.TrelloMockUtils && window.TrelloMockUtils.isMockMode()) {
                window.TrelloMockUtils.mockTrelloIframe();
            }
            
            applyTheme();
        }
        
        setTimeout(initialize, 100);
    </script>
</body>
</html>